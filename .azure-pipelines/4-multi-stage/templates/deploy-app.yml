trigger: none
pr: none

parameters:
  environment: '$(Environment)'
  appServicePlanName: '$(AppServicePlanName)'
  webAppName: '$(WebAppName)'
  azureConnectionName: '$(AzureConnectionName)'
  subscriptionId: '$(SubscriptionId)'
  resourceGroupName: '$(ResourceGroupName)'
  location: 'North Europe'
  sku: 'F1'
  
resources:
  pipelines:
  - pipeline: BuildApp
    source: 'Build app with tasks'
  
variables:
- group: ms-common
- group: ms-${{ parameters.environment }}

jobs:
- deployment: deploy
  displayName: 'Deploy app on ${{ parameters.environment }}'
  environment: ${{ parameters.environment }}
  strategy:
    runOnce:
      preDeploy:
        steps:
        - task: AzureResourceManagerTemplateDeployment@3
          inputs:
            deploymentScope: 'Resource Group'
            azureResourceManagerConnection: '${{ parameters.azureConnectionName }}'
            subscriptionId: '${{ parameters.subscriptionId }}'
            action: 'Create Or Update Resource Group'
            resourceGroupName: '${{ parameters.resourceGroupName }}'
            location: '${{ parameters.location }}'
            templateLocation: 'URL of the file'
            csmFileLink: 'https://raw.githubusercontent.com/patrikulus/devops-project-samples/master/dotnet/aspnetcore31/webAppOnLinux/ArmTemplates/linux-webapp-template.json'
            overrideParameters: '-webAppName ${{ parameters.webAppName }} -hostingPlanName ${{ parameters.appServicePlanName }} -appInsightsLocation ${{ parameters.location }} -sku ${{ parameters.sku }}'
      deploy:
        steps:
        - download: BuildApp
        - task: AzureRmWebAppDeployment@4
          displayName: 'Deploy Azure App Service'
          inputs:
            ConnectionType: 'AzureRM'
            azureSubscription: '${{ parameters.azureConnectionName }}'
            appType: 'webAppLinux'
            WebAppName: '${{ parameters.webAppName }}'
            packageForLinux: '$(System.DefaultWorkingDirectory)/**/*.zip'
      on:
        failure:
          steps:
          - script: 'curl https://maker.ifttt.com/trigger/deployment_failed/with/key/$(MakerKey)'
        success:
          steps:
          - script: 'curl https://maker.ifttt.com/trigger/deployment_success/with/key/$(MakerKey)'